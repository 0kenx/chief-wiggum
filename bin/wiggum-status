#!/usr/bin/env bash
# Show status of workers

WIGGUM_HOME="${WIGGUM_HOME:-$HOME/.claude/chief-wiggum}"
PROJECT_DIR="$(pwd)"
RALPH_DIR="$PROJECT_DIR/.ralph"

source "$WIGGUM_HOME/lib/circuit-breaker.sh" 2>/dev/null || true

show_help() {
    cat << EOF
wiggum status - Show status of workers

Usage: wiggum status [options]

Options:
  -h, --help          Show this help message

Description:
  Displays the current status of all workers including:
  - Which workers are running
  - Worker PIDs
  - Recent activity from logs

Examples:
  wiggum status        # Show current worker status

EOF
}

# Parse options
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo ""
            show_help
            exit 1
            ;;
    esac
done

# Check for active workers by scanning worker directories
if [ ! -d "$RALPH_DIR/workers" ]; then
    echo "No wiggum workers found in this project"
    exit 0
fi

# Collect active workers from worker directories
worker_count=0
running_count=0
declare -a worker_pids
declare -a worker_names

for worker_dir in "$RALPH_DIR/workers"/worker-*; do
    [ -d "$worker_dir" ] || continue

    pid_file="$worker_dir/worker.pid"
    [ -f "$pid_file" ] || continue

    pid=$(cat "$pid_file" 2>/dev/null)
    worker_id=$(basename "$worker_dir")

    # Validate PID is a number
    if ! [[ "$pid" =~ ^[0-9]+$ ]]; then
        rm -f "$pid_file"
        continue
    fi

    ((worker_count++))
    if kill -0 "$pid" 2>/dev/null; then
        # Verify it's actually a worker process
        if ps -p "$pid" -o args= 2>/dev/null | grep -q "lib/worker.sh"; then
            ((running_count++))
            worker_pids+=("$pid")
            worker_names+=("$worker_id")
        else
            # Stale PID file (PID reused)
            rm -f "$pid_file"
        fi
    else
        # Process no longer running
        rm -f "$pid_file"
    fi
done

# Check if any workers are running
if [ $running_count -eq 0 ]; then
    echo "No wiggum process running in this project"
    exit 0
fi

echo "=== Chief Wiggum Status ==="
echo "Project: $PROJECT_DIR"
echo ""

# Check orchestrator status
orchestrator_lock="$RALPH_DIR/.orchestrator.pid"
if [ -f "$orchestrator_lock" ]; then
    orchestrator_pid=$(cat "$orchestrator_lock" 2>/dev/null)
    if [[ "$orchestrator_pid" =~ ^[0-9]+$ ]] && kill -0 "$orchestrator_pid" 2>/dev/null; then
        if ps -p "$orchestrator_pid" -o args= 2>/dev/null | grep -q "wiggum-run"; then
            echo "Orchestrator: RUNNING (PID: $orchestrator_pid)"
        else
            echo "Orchestrator: NOT RUNNING (stale lock)"
        fi
    else
        echo "Orchestrator: NOT RUNNING (stale lock)"
    fi
else
    echo "Orchestrator: NOT RUNNING"
fi
echo ""

# Display running workers with circuit breaker status
for i in "${!worker_pids[@]}"; do
    worker_name="${worker_names[$i]}"
    worker_pid="${worker_pids[$i]}"
    worker_dir="$RALPH_DIR/workers/$worker_name"

    echo "✓ Worker $worker_name (PID: $worker_pid) - RUNNING"

    # Show circuit breaker status if available
    if [ -f "$worker_dir/circuit-state.json" ] && type cb_get_status_line &>/dev/null; then
        cb_status=$(cb_get_status_line "$worker_dir")
        echo "    $cb_status"
    fi
done

echo ""
echo "Total: $worker_count workers, $running_count running"

# Show any workers with tripped circuit breakers (even if not running)
tripped_count=0
if [ -d "$RALPH_DIR/workers" ]; then
    for worker_dir in "$RALPH_DIR/workers"/worker-*; do
        [ -d "$worker_dir" ] || continue
        state_file="$worker_dir/circuit-state.json"
        if [ -f "$state_file" ]; then
            state=$(jq -r '.state // "CLOSED"' "$state_file" 2>/dev/null)
            if [ "$state" = "OPEN" ]; then
                if [ $tripped_count -eq 0 ]; then
                    echo ""
                    echo "Tripped Circuit Breakers:"
                fi
                ((tripped_count++))
                worker_name=$(basename "$worker_dir")
                reason=$(jq -r '.trip_reason // "UNKNOWN"' "$state_file")
                message=$(jq -r '.trip_message // ""' "$state_file")
                echo "  ✗ $worker_name: $reason - $message"
            fi
        fi
    done
fi

if [ $tripped_count -gt 0 ]; then
    echo ""
    echo "Use 'wiggum run --reset-circuit' to reset and retry"
fi

# Show recent activity from logs
if [ -f "$RALPH_DIR/logs/workers.log" ]; then
    echo ""
    echo "Recent activity (last 5 lines):"
    tail -5 "$RALPH_DIR/logs/workers.log" | sed 's/^/  /'
fi
